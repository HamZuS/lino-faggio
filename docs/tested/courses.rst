.. _faggio.tested.courses:

Courses
=======

.. only this doc:
  python setup.py test -s tests.DocsTests.test_courses

This document analyzes the demo courses generated by 
:mod:`lino_faggio.fixtures.faggio`.

.. include:: /include/tested.rst

>>> from django.conf import settings
>>> from lino.runtime import *
>>> from lino.utils import i2d
>>> from django.test.client import Client
>>> from django.utils.translation import get_language
>>> from django.utils import translation
>>> import json

The first demo course starts on December 2, 2013:

>>> obj = courses.Course.objects.get(pk=3)
>>> print(obj)
comp (12/2/13 Butgenbach (Computer room))

>>> ses = rt.login('robin')

..

    Repair from previous incomplete test runs.

    >>> res = obj.do_update_events(ses)
    >>> res['success']
    True



>>> ses.show(cal.EventsByController, obj, column_names="when_text state")
====================== ===========
 When                   State
---------------------- -----------
 Mon 12/2/13 (13:30)    Suggested
 Mon 12/9/13 (13:30)    Suggested
 Mon 12/16/13 (13:30)   Suggested
 Mon 12/23/13 (13:30)   Suggested
 Mon 12/30/13 (13:30)   Suggested
 Mon 1/6/14 (13:30)     Suggested
 Mon 1/13/14 (13:30)    Suggested
 Mon 1/20/14 (13:30)    Suggested
====================== ===========
<BLANKLINE>


We run the UpdateEvents action a first time and verify that the events
remain unchanged (if the following fails, make sure you've run
:cmd:`fab initdb` before running :cmd:`fab test`).

>>> import logging
>>> logger = logging.getLogger('lino')
>>> logger.setLevel('DEBUG')
>>> res = ses.run(obj.do_update_events)
>>> res['success']
True
>>> print(res['info_message'])
Update Events for comp (12/2/13 Butgenbach (Computer room))...
Generating events between 2013-12-02 and 2019-05-22.
8 row(s) have been updated.
>>> ses.show(cal.EventsByController, obj, column_names="when_text state")
====================== ===========
 When                   State
---------------------- -----------
 Mon 12/2/13 (13:30)    Suggested
 Mon 12/9/13 (13:30)    Suggested
 Mon 12/16/13 (13:30)   Suggested
 Mon 12/23/13 (13:30)   Suggested
 Mon 12/30/13 (13:30)   Suggested
 Mon 1/6/14 (13:30)     Suggested
 Mon 1/13/14 (13:30)    Suggested
 Mon 1/20/14 (13:30)    Suggested
====================== ===========
<BLANKLINE>

We select the event no 4 (2013-12-23):

>>> qs = obj.get_existing_auto_events()
>>> e = qs.get(start_date=i2d(20131223))

Yes, the state is "suggested":

>>> print(e.state)
suggested

Now we move that to the week after:

>>> res = e.move_next(ses)
>>> res['success']
True
>>> print(res['info_message'])
Move down for Course #3 Hour 4...
1 row(s) have been updated.

The state is now "draft":

>>> print(e.state)
draft

We have now two events on 20131230:

>>> ses.show(cal.EventsByController, obj, column_names="when_text state")
====================== ===========
 When                   State
---------------------- -----------
 Mon 12/2/13 (13:30)    Suggested
 Mon 12/9/13 (13:30)    Suggested
 Mon 12/16/13 (13:30)   Suggested
 Mon 12/30/13 (13:30)   Draft
 Mon 12/30/13 (13:30)   Suggested
 Mon 1/6/14 (13:30)     Suggested
 Mon 1/13/14 (13:30)    Suggested
 Mon 1/20/14 (13:30)    Suggested
====================== ===========
<BLANKLINE>

To solve that, we must click on the lightning button:

>>> res = obj.do_update_events(ses)
>>> res['success']
True

>>> ses.show(cal.EventsByController, obj, column_names="when_text state")
====================== ===========
 When                   State
---------------------- -----------
 Mon 12/2/13 (13:30)    Suggested
 Mon 12/9/13 (13:30)    Suggested
 Mon 12/16/13 (13:30)   Suggested
 Mon 12/30/13 (13:30)   Draft
 Mon 1/6/14 (13:30)     Suggested
 Mon 1/13/14 (13:30)    Suggested
 Mon 1/20/14 (13:30)    Suggested
 Mon 1/27/14 (13:30)    Suggested
====================== ===========
<BLANKLINE>

Click on the "Reset" button:

>>> e.state = cal.EventStates.suggested
>>> e.save()

Re-run UpdateEvents to restore original state:

>>> res = ses.run(obj.do_update_events)
>>> res['success']
True
>>> ses.show(cal.EventsByController, obj, column_names="when_text state")
====================== ===========
 When                   State
---------------------- -----------
 Mon 12/2/13 (13:30)    Suggested
 Mon 12/9/13 (13:30)    Suggested
 Mon 12/16/13 (13:30)   Suggested
 Mon 12/23/13 (13:30)   Suggested
 Mon 12/30/13 (13:30)   Suggested
 Mon 1/6/14 (13:30)     Suggested
 Mon 1/13/14 (13:30)    Suggested
 Mon 1/20/14 (13:30)    Suggested
====================== ===========
<BLANKLINE>

