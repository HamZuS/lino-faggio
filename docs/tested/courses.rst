.. _faggio.tested.courses:

Courses
=======

This document analyzes the demo courses generated by 
:mod:`lino_faggio.fixtures.faggio`.

.. include:: /include/tested.rst

>>> from django.conf import settings
>>> from lino.runtime import *
>>> from lino import dd
>>> from lino.utils import i2d
>>> from django.test.client import Client
>>> from django.utils.translation import get_language
>>> from django.utils import translation
>>> import json

The first demo course starts on December 2, 2013:

>>> obj = courses.Course.objects.get(pk=1)
>>> print(obj)
First Steps (12/2/13 Butgenbach (Computerroom))

>>> ses = dd.login('robin')

..

    Repair from previous incomplete test runs.

    >>> res = obj.do_update_events(ses)
    >>> res['success']
    True



>>> ses.show(cal.EventsByController, obj, column_names="when_text state")
============================= ===========
 When                          State
----------------------------- -----------
 **2013 Dec 02 (Mon) 13:30**   Suggested
 **2013 Dec 09 (Mon) 13:30**   Suggested
 **2013 Dec 16 (Mon) 13:30**   Suggested
 **2013 Dec 23 (Mon) 13:30**   Suggested
 **2013 Dec 30 (Mon) 13:30**   Suggested
 **2014 Jan 06 (Mon) 13:30**   Suggested
 **2014 Jan 13 (Mon) 13:30**   Suggested
 **2014 Jan 20 (Mon) 13:30**   Suggested
============================= ===========
<BLANKLINE>

We run the UpdateEvents action a first time and verify that the events
remain unchanged (if the following fails, make sure you've run
:cmd:`fab initdb`).

>>> import logging
>>> logger = logging.getLogger('lino')
>>> logger.setLevel('DEBUG')
>>> res = ses.run(obj.do_update_events)
>>> res['success']
True
>>> print(res['info_message'])
Update Events for First Steps (12/2/13 Butgenbach (Computerroom))...
Generating events between 2013-12-02 and 2019-06-25.
8 row(s) have been updated.
>>> ses.show(cal.EventsByController, obj, column_names="when_text state")
============================= ===========
 When                          State
----------------------------- -----------
 **2013 Dec 02 (Mon) 13:30**   Suggested
 **2013 Dec 09 (Mon) 13:30**   Suggested
 **2013 Dec 16 (Mon) 13:30**   Suggested
 **2013 Dec 23 (Mon) 13:30**   Suggested
 **2013 Dec 30 (Mon) 13:30**   Suggested
 **2014 Jan 06 (Mon) 13:30**   Suggested
 **2014 Jan 13 (Mon) 13:30**   Suggested
 **2014 Jan 20 (Mon) 13:30**   Suggested
============================= ===========
<BLANKLINE>


We select the event no 4 (2013-12-23):

>>> qs = obj.get_existing_auto_events()
>>> e = qs.get(start_date=i2d(20131223))

Yes, the state is "suggested":

>>> print(e.state)
suggested

Now we move that to the week after:

>>> res = e.move_next(ses)
>>> res['success']
True
>>> print(res['info_message'])
Move down for Course #1 Heure 4...
1 row(s) have been updated.

The state is now "draft":

>>> print(e.state)
draft

We have now two events on 20131230:

>>> ses.show(cal.EventsByController, obj, column_names="when_text state")
============================= ===========
 When                          State
----------------------------- -----------
 **2013 Dec 02 (Mon) 13:30**   Suggested
 **2013 Dec 09 (Mon) 13:30**   Suggested
 **2013 Dec 16 (Mon) 13:30**   Suggested
 **2013 Dec 30 (Mon) 13:30**   Draft
 **2013 Dec 30 (Mon) 13:30**   Suggested
 **2014 Jan 06 (Mon) 13:30**   Suggested
 **2014 Jan 13 (Mon) 13:30**   Suggested
 **2014 Jan 20 (Mon) 13:30**   Suggested
============================= ===========
<BLANKLINE>

To solve that, we must click on the lightning button:

>>> res = obj.do_update_events(ses)
>>> res['success']
True

>>> ses.show(cal.EventsByController, obj, column_names="when_text state")
============================= ===========
 When                          State
----------------------------- -----------
 **2013 Dec 02 (Mon) 13:30**   Suggested
 **2013 Dec 09 (Mon) 13:30**   Suggested
 **2013 Dec 16 (Mon) 13:30**   Suggested
 **2013 Dec 30 (Mon) 13:30**   Draft
 **2014 Jan 06 (Mon) 13:30**   Suggested
 **2014 Jan 13 (Mon) 13:30**   Suggested
 **2014 Jan 20 (Mon) 13:30**   Suggested
 **2014 Jan 27 (Mon) 13:30**   Suggested
============================= ===========
<BLANKLINE>

Click on the "Reset" button:

>>> e.state = cal.EventStates.suggested
>>> e.save()

Re-run UpdateEvents to restore original state:

>>> res = ses.run(obj.do_update_events)
>>> res['success']
True
>>> ses.show(cal.EventsByController, obj, column_names="when_text state")
============================= ===========
 When                          State
----------------------------- -----------
 **2013 Dec 02 (Mon) 13:30**   Suggested
 **2013 Dec 09 (Mon) 13:30**   Suggested
 **2013 Dec 16 (Mon) 13:30**   Suggested
 **2013 Dec 23 (Mon) 13:30**   Suggested
 **2013 Dec 30 (Mon) 13:30**   Suggested
 **2014 Jan 06 (Mon) 13:30**   Suggested
 **2014 Jan 13 (Mon) 13:30**   Suggested
 **2014 Jan 20 (Mon) 13:30**   Suggested
============================= ===========
<BLANKLINE>

